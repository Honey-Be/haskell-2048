<html>
<head>
	<link rel="stylesheet" href="stylesheet.css">
	
	<!-- jQuery -->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

	<!-- Knockout.js -->
	<script src='//cdnjs.cloudflare.com/ajax/libs/knockout/3.1.0/knockout-min.js'></script>
	
	<!-- Knockout Mapping -->
	<script src='//cdnjs.cloudflare.com/ajax/libs/knockout.mapping/2.4.1/knockout.mapping.js'></script>
	
	<title>2048</title>
</head>

<body> 
	<div id ="game-frame">
		<div id="game-container">
			<div id = "top">
				<h1>2048-Haskell</h1>
				<div id="sidePanel">
					<div id="score">SCORE</br /><span data-bind="text: score"></span></div>
					<div id="newGameButton" data-bind="click: startNewGame">New Game</div>
				</div>
				<p id="description">Join the numbers and get to the 2048 tile!</p>
			</div>

			<div id="grid">
				<table>
				    <tbody data-bind="foreach: grid">
				        <tr data-bind="foreach: $data">
				            <td data-bind="text: (tile() === '0' ? '' : tile()), style: { backgroundColor: getTileColor(tile()) }"></td>
				        </tr>
				    </tbody>
				</table>
			</div>
			<div id="game-id" data-bind="text: 'Game ID: ' + gameid()"></div>
			<div id= "byline">
				<p>&copy Mark McGuill</p>
			</div>
		</div>
	</div>

	<script type="text/javascript">
		var viewModel = null;
		updateFromServer();

		function updateFromServer () {
			makeRestCallAndUpdateViewModel("/gameState");
		}

		function startNewGame() {
			makeRestCallAndUpdateViewModel("/newGame");
		}

		function makeRestCallAndUpdateViewModel(operation){
			$.getJSON(operation)
			.done(function(data) {
				updateViewModelWithJsonData(data);
			}).fail(function() {
				console.log("Problem getting update from server for [" + operation + "] operation...");
			});
		}

		function updateViewModelWithJsonData(data) {
				if(viewModel){
					ko.mapping.fromJS(data, viewModel);
				}
				else{
					viewModel = ko.mapping.fromJS(data);
					ko.applyBindings(viewModel);
					
					// We have good state, so let's initialize the key bindings so play can begin

					$('body').keydown(function(e){
					    switch (e.which) {
					        case 40:
					            makeRestCallAndUpdateViewModel("/moveDown");
					            break;
					        case 38:
					            makeRestCallAndUpdateViewModel("/moveUp");
					            break;
					        case 37:
					            makeRestCallAndUpdateViewModel("/moveLeft");
					            break;
					        case 39:
					            makeRestCallAndUpdateViewModel("/moveRight");
					            break;
					        }      
					});
				}
		}

		function getTileColor(tile){
			//console.log(tile);
        	if(tile == 2) 			{ return "rgb(238,228,218)"; }
            else if(tile == 4) 		{ return "rgb(237, 224, 200)"; }
            else if(tile == 8) 		{ return "rgb(242, 177, 121)"; }
            else if(tile == 16) 	{ return "rgb(245, 149, 99)"; }
            else if(tile == 32) 	{ return "rgb(246, 124, 95)"; }
            else if(tile == 64 ) 	{ return "rgb(246, 94, 59)"; }
            else if(tile == 128 ) 	{ return "rgb(237, 207, 114)"; }
            else if(tile == 256 ) 	{ return "rgb(237, 204, 97)"; }
            else if(tile == 512 ) 	{ return "rgb(237, 200, 80)"; }
            else if(tile == 1024 ) 	{ return "rgb(237, 197, 63)"; }
            else if(tile == 2048 ) 	{ return "rgb(237, 194, 46)"; }
            else 					  return "rgba(238, 228, 218, 0.35)"; // empty tile
		}
	</script>
</body>
</html>